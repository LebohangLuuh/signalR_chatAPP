@model groupChat.Models.WebsiteVistorData

<link href="~/Content/sweetalert.css" rel="stylesheet" />
<link href="~/Content/chatcss.css" rel="stylesheet" />

<div class="pull-left">
    <h3 style="color:green ">NAME : <span class="label label-success label-text txtName"></span></h3>
    <input type="hidden" id="txtName" />
</div>
<br />
<br />
<br />

<input type="hidden" id="URL" />
<input type="hidden" id="ip" value="@Model.Ip"/>
<input type="hidden" id="city" value="@Model.City"/>
<input type="hidden" id="region" value="@Model.RegionName"/>
<input type="hidden" id="country" value="@Model.Country"/>
<input type="hidden" id="loc" value="@Model.Lat @Model.Lon"/>
<input type="hidden" id="org" value="@Model.Org"/>
<input type="hidden" id="postal" value="@Model.Zip"/>
<input type="hidden" id="mac" value="@Model.MacId" />
<input type="hidden" id="clientMachineName" value="@Model.ClientMachineName" />
<input type="hidden" id="HTTP_USER_AGENT" />
<input type="hidden" id="HTTP_REFERER" />



<!--------------------------------------------Real-time Clients Chat Conversation---------------------------------------------------------->
<div class="container form-horizontal">
    <h2 class="text-center" style="color:green">Clients Chat </h2>

    <div class="container-fluid chat-display-border" style="color:green; border-color: darkseagreen;">
        <div id="messagesClient" class="bubble-dialog"></div>
    </div>

    <br />


    <div class="form-group ">
        <div class="col-sm-6">
            <textarea class="form-control" placeholder="type your message here" cols="6" rows="2" id="txtMessageClient"></textarea>
        </div>

        <div class="col-sm-2">
            <input type="button" class="btn btn-success" id="broadcastClientMessage" value="Send Message" />
        </div>
    </div>


</div>

<!--------------------------------------------------------------------------------------------------------------------------------------->


@section scripts {
    <script src="~/Scripts/jquery-3.4.1.min.js"></script>
    <!--sweetalert UI javascript-->
    <script src="~/Content/sweetalert.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script type="text/javascript">
        $(function () {
            // Proxy created on Page Load
            var chat = $.connection.letsChatHub;

          
            /*------------ Declare a function on the chat hub so the server can invoke it for All Client Chat------------------*/
            chat.client.addChatMessage = function (name, message) {


                $('#messagesClient').append('<div class="bubble-left">' + name + ' : ' + message + '<br>' + currentTime() + '</div>');

            };

       

            // Start the connection
            $.connection.hub.start().done(function () {
                //Display Connection ID to USER
                $("#connId").text($.connection.hub.id);
                console.log('Now connected, connection ID =' + $.connection.hub.id);
                //call function for taking UserName
                userName()


                /*------------------------FOR Client CHAT When try to send message-----------------------------------------*/
                $("#broadcastClientMessage").click(function () {
                    let userFullName = $('#txtName').val().length != 0 ? $('#txtName').val() : userName();
                    console.log("User Name : ", userFullName);

                    if ($('#txtName').val().length != 0 && $('#txtMessageClient').val().length != 0) {

                        $('#messagesClient').append('<div class="bubble-right">' + $('#txtName').val() + " : " + $('#txtMessageClient').val() + '<br>' + currentTime() + '</div>');
                        // Call the chatGroup method on the server
                        chat.server.sendChatMessage($.connection.hub.id, $('#txtName').val(), $('#txtMessageClient').val());
                        //Clear textBox message after sending message.
                        $('#txtMessageClient').val('');
                    } else {

                        alert('Your Name and Message are Required');
                    }
                });

                //Any Error
            }).fail(function (e) {
                console.log(e);
            });
        });
        //Return Current Time In chat text
        function currentTime() {
            return new Date().toLocaleString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        // Get the user name and store it to prepend to messages.
        function userName() {
            return swal({
                title: "Lets Chat!",
                text: "<span style='color:#f8bb86;font-weight:700;'>Enter your name:</span>",
                type: "input",
                html: true,
                showCancelButton: true,
                closeOnConfirm: true,
                animation: "slide-from-top",
                inputPlaceholder: "Enter your name"
            },
                function (inputValue) {

                    if (inputValue === false || inputValue === "") {
                        console.log("Entered Name : ", inputValue);
                        return false;
                    } else {

                        console.log("Entered Name : ", inputValue);
                        $('#txtName').val(inputValue);
                        $('.txtName').text(inputValue);

                        //ajaxCall
                        var data = { userName: $('#txtName').val(), connectionID: $.connection.hub.id }
                        console.log("dataToSend", JSON.stringify(data));
                        $.ajax({
                            type: "POST",
                            url: "/Home/ajaxSenderUserName",
                            data: JSON.stringify(data),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (response) {
                                console.log("Response From Server : ", response)
                            },
                            failure: function (response) {
                                //alert(response.responseText);
                            },
                            error: function (response) {
                                //alert(response.responseText);
                            }
                        });
                    }

                });
        }
        function alertConnectionIdCopied() {
            swal("Good job!", "Connection ID copied!", "success");
        }
       

    </script>
}
